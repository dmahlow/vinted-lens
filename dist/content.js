(()=>{"use strict";new class{constructor(){this.state={isEnabled:!0,isScanning:!1,preferences:[],currentSearch:null,scanProgress:null},this.scanQueue=[],this.activeProducts=new Set,this.MAX_CONCURRENT=8,this.initialize()}async initialize(){console.log("ðŸ” Vinted Lens: Initializing content script");const e=await browser.storage.local.get(["preferences","currentSearch"]);this.state.preferences=e.preferences||[],this.state.currentSearch=e.currentSearch||null,console.log("ðŸ“‹ Loaded preferences:",this.state.preferences),console.log("ðŸ”Ž Current search:",this.state.currentSearch),browser.runtime.onMessage.addListener(this.handleMessage.bind(this)),console.log("ðŸ‘‚ Message listener set up")}handleMessage(e){switch(e.type){case"START_SCAN":this.handleStartScan(e.payload);break;case"STOP_SCAN":this.handleStopScan(e.payload);break;case"ANALYSIS_COMPLETE":this.handleAnalysisComplete(e.payload);break;case"ANALYSIS_STATUS":this.handleAnalysisStatus(e.payload);break;case"UPDATE_PREFERENCES":this.handlePreferencesUpdate(e.payload);break;case"UPDATE_SEARCH":this.handleSearchUpdate(e.payload);break;case"SHOW_TOAST":this.showToast(e.payload)}}handleAnalysisStatus(e){const{stage:t,productId:s,data:a}=e;switch(t){case"start":console.log(`ðŸ¤– Analyzing product ${s}:`,{prompt:a?.prompt});break;case"complete":console.log(`âœ… Claude response for ${s}:`,{response:a?.response,timing:a?.timing});break;case"error":console.error(`âŒ Analysis failed for ${s}:`,{error:a?.error})}}handleStartScan(e){this.state.isScanning?console.log("â³ Scan already in progress"):(this.state.preferences=e.preferences,this.state.currentSearch=e.searchTerm,this.scanQueue=this.getUnanalyzedProducts(),0!==this.scanQueue.length?(this.state.isScanning=!0,this.state.scanProgress={total:this.scanQueue.length,current:0,currentItem:null,startTime:Date.now()},this.updateProgress(),this.processNextProduct()):this.showToast({message:"No items to analyze",type:"info"}))}handleStopScan(e){this.state.isScanning&&(console.log("ðŸ›‘ Stopping scan:",e.reason),this.scanQueue=[],this.activeProducts.clear(),this.state.isScanning=!1,this.state.scanProgress=null,this.showToast({message:"complete"===e.reason?"Scan complete":"Scan stopped",type:"error"===e.reason?"error":"info"}),this.updateProgress())}getUnanalyzedProducts(){const e=[];return document.querySelectorAll(".feed-grid__item:not(.vinted-lens-analyzed)").forEach(((t,s)=>{const a=t.querySelector('img[data-testid="feed-item--image--img"]'),n=t.querySelector('[data-testid="feed-item--description-title"]'),i=t.querySelector('[data-testid="feed-item--overlay-link"]');a&&n&&i&&e.push({id:`item-${Date.now()}-${s}`,element:t,imageUrl:a.src,title:n.textContent||"",description:i.getAttribute("title")||""})})),e}async processNextProduct(){if(this.state.isScanning){for(;this.scanQueue.length>0&&this.activeProducts.size<this.MAX_CONCURRENT;){const e=this.scanQueue.shift();console.log("ðŸ”„ Processing product:",e.id,{activeProducts:this.activeProducts.size,queueLength:this.scanQueue.length}),this.state.scanProgress&&(this.state.scanProgress.current++,this.state.scanProgress.currentItem=e.title,this.updateProgress()),e.element.setAttribute("data-vinted-lens-id",e.id),e.element.classList.add("vinted-lens-analyzing"),this.activeProducts.add(e.id),this.analyzeProduct(e).catch((t=>{console.error("âŒ Analysis failed:",t),this.activeProducts.delete(e.id),e.element.classList.remove("vinted-lens-analyzing"),this.processNextProduct()}))}0===this.scanQueue.length&&0===this.activeProducts.size&&this.handleStopScan({reason:"complete"})}}async analyzeProduct(e){console.log("ðŸ“¤ Sending product for analysis:",{id:e.id,imageUrl:e.imageUrl,title:e.title,queueLength:this.scanQueue.length,activeProducts:this.activeProducts.size}),await browser.runtime.sendMessage({type:"ANALYZE_PRODUCT",payload:{product:{...e,element:void 0},preferences:this.state.preferences,searchTerm:this.state.currentSearch}})}handleAnalysisComplete(e){const{productId:t,analysis:s}=e;console.log("ðŸ“¥ Analysis complete:",{productId:t,matches:s.matches,confidence:s.confidence,timing:s.timing,queueSize:this.scanQueue.length});const a=document.querySelector(`.feed-grid__item[data-vinted-lens-id="${t}"]`);if(!a)return console.warn("âš ï¸ No element found for product:",t),this.activeProducts.delete(t),void this.processNextProduct();a.classList.remove("vinted-lens-analyzing"),a.classList.add("vinted-lens-analyzed"),a.classList.add("vinted-lens-transition"),setTimeout((()=>{s.matches?(a.classList.add("vinted-lens-match"),s.confidence<.8&&a.classList.add("vinted-lens-low-confidence")):a.classList.add("vinted-lens-hidden"),this.activeProducts.delete(t),this.processNextProduct()}),0)}updateProgress(){this.state.scanProgress&&browser.runtime.sendMessage({type:"SCAN_PROGRESS",payload:{progress:this.state.scanProgress}})}handlePreferencesUpdate(e){this.state.preferences=e.preferences,this.resetAnalysis()}handleSearchUpdate(e){this.state.currentSearch=e.search,this.resetAnalysis()}resetAnalysis(){this.state.isScanning&&this.handleStopScan({reason:"user"}),document.querySelectorAll(".vinted-lens-match, .vinted-lens-hidden, .vinted-lens-low-confidence, .vinted-lens-analyzed").forEach((e=>{e.classList.remove("vinted-lens-match","vinted-lens-hidden","vinted-lens-low-confidence","vinted-lens-analyzed"),e.removeAttribute("data-vinted-lens-id")}))}showToast(e){const t=document.createElement("div");t.className=`vinted-lens-toast ${e.type||""}`,t.textContent=e.message,document.body.appendChild(t),t.offsetHeight,t.classList.add("show"),setTimeout((()=>{t.classList.remove("show"),setTimeout((()=>t.remove()),300)}),e.duration||3e3)}}})();
//# sourceMappingURL=content.js.map