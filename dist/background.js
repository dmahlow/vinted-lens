(()=>{"use strict";new class{constructor(){this.apiKey=null,this.imageDetail="auto",this.costLimit=0,this.costTracking={monthlyTokens:0,monthlyImages:0,estimatedCost:0,lastReset:(new Date).toISOString()},this.initialize()}async initialize(){console.log("🔍 Vinted Lens: Initializing background script");const e=await browser.storage.local.get(["apiKey","imageDetail","costLimit","monthlyUsage"]),t=e.apiKey;console.log("🔑 Raw API key from storage:",t),console.log("🔑 API key details:",{present:!!t,value:t,keyType:t?typeof t:"null",startsWith:t?t.substring(0,7):"n/a",length:t?t.length:0,storage_key_used:"apiKey"}),this.apiKey=t||null,console.log("🔑 API key after assignment:",{value:this.apiKey,valid:this.isValidApiKey(this.apiKey)}),this.imageDetail=e.imageDetail||"auto",this.costLimit=e.costLimit||0,this.costTracking=e.monthlyUsage||{monthlyTokens:0,monthlyImages:0,estimatedCost:0,lastReset:(new Date).toISOString()},browser.storage.onChanged.addListener(((e,t)=>{"local"===t&&e.apiKey&&(console.log("🔄 API key changed:",{oldValue:e.apiKey.oldValue?"[REDACTED]":null,newValue:e.apiKey.newValue?"[REDACTED]":null}),this.apiKey=e.apiKey.newValue||null,console.log("🔄 API key after change:",{value:this.apiKey,valid:this.isValidApiKey(this.apiKey)}))}));const a=new Date(this.costTracking.lastReset),s=new Date;a.getMonth()===s.getMonth()&&a.getFullYear()===s.getFullYear()||(this.costTracking={monthlyTokens:0,monthlyImages:0,estimatedCost:0,lastReset:s.toISOString()},await this.saveCostTracking()),console.log("🔑 Settings loaded:",{apiKeyPresent:!!this.apiKey,apiKeyValid:this.isValidApiKey(this.apiKey),imageDetail:this.imageDetail,costLimit:this.costLimit,costTracking:this.costTracking}),browser.runtime.onMessage.addListener(this.handleMessage.bind(this)),console.log("👂 Message listener set up")}async saveCostTracking(){await browser.storage.local.set({monthlyUsage:this.costTracking})}async updateCostTracking(e){if(this.costTracking.monthlyTokens+=e,this.costTracking.monthlyImages+=1,this.costTracking.estimatedCost=1e-5*this.costTracking.monthlyTokens+.2*this.costTracking.monthlyTokens*3e-5,await this.saveCostTracking(),this.costLimit>0&&this.costTracking.estimatedCost>this.costLimit)throw new Error("Monthly cost limit exceeded")}async handleMessage(e){"ANALYZE_PRODUCT"===e.type&&await this.handleProductAnalysis(e.payload)}isValidApiKey(e){return!!e&&(e.startsWith("sk-")||e.startsWith("sk-proj-"))}async handleProductAnalysis(e){if(console.log("📦 Analyzing product:",e.product.id),!this.isValidApiKey(this.apiKey))return console.error("❌ No valid API key found"),void await this.showToast({message:"Please set your API key in the extension options",type:"error"});try{const t=performance.now(),a=await this.analyzeProduct(e),s=performance.now()-t;await this.sendToActiveTab({type:"ANALYSIS_COMPLETE",payload:{productId:e.product.id,analysis:{...a,timing:{...a.timing,total:s}}}})}catch(e){console.error("❌ Analysis failed:",e),await this.showToast({message:"Failed to analyze product",type:"error"})}}async sendToActiveTab(e){const t=await browser.tabs.query({active:!0,currentWindow:!0});t[0]?.id&&await browser.tabs.sendMessage(t[0].id,e)}extractJsonFromResponse(e){const t=e.match(/```(?:json)?\n?(.*?)```/s);return t?t[1].trim():e.trim()}async analyzeProduct(e){if(!this.apiKey)throw new Error("API key is required");const{product:t,preferences:a,searchTerm:s}=e;await this.sendToActiveTab({type:"ANALYSIS_STATUS",payload:{stage:"start",productId:t.id,data:{prompt:`Analyzing if product matches either:\n${s?`- Search term: "${s}"`:""}\n${a.length>0?`- Preferences: ${a.join(", ")}`:""}`}}});const i=performance.now(),o=[{role:"user",content:[{type:"text",text:`Analyze if this product matches either:\n${s?`- Search term: "${s}"`:""}\n${a.length>0?`- Preferences: ${a.join(", ")}`:""}\n\nProduct details:\nTitle: ${t.title}\nDescription: ${t.description}\n\nRespond in JSON format:\n{\n  "matches": boolean,\n  "confidence": number between 0 and 1,\n  "matchedCriteria": string[], // "search" or the specific preference that matched\n  "description": string explaining why it matched or didn't match\n}`}]}];let n,r;try{const{data:e,mediaType:a}=await async function(e){const t=await fetch(e),a=await t.blob(),s=a.type||"image/jpeg";return new Promise(((e,t)=>{const i=new FileReader;i.onloadend=()=>{const t=i.result.split(",")[1];e({data:t,mediaType:s})},i.onerror=t,i.readAsDataURL(a)}))}(t.imageUrl);o[0].content.push({type:"image_url",image_url:{url:`data:${a};base64,${e}`,detail:this.imageDetail}});const s={model:"gpt-4o-mini",messages:o,max_tokens:300},c={"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`};console.log("🔄 OpenAI API Request:",{url:"https://api.openai.com/v1/chat/completions",method:"POST",headers:{...c,Authorization:"Bearer [REDACTED]"},body:JSON.stringify(s,null,2)}),n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:c,body:JSON.stringify(s)});const l=await n.text();if(console.log("🔄 OpenAI API Response:",{status:n.status,statusText:n.statusText,headers:Object.fromEntries(n.headers.entries()),body:l}),!n.ok){let e=`API request failed (${n.status})`;if(401===n.status)e="Invalid API key. Make sure you're using a valid API key from platform.openai.com";else if(429===n.status)e="Rate limit exceeded. Please try again later.";else if(400===n.status)e="Invalid request format";else try{const t=JSON.parse(l);e+=`: ${t.error?.message||l}`}catch{e+=`: ${l}`}throw new Error(e)}r=JSON.parse(l);const d=performance.now()-i,h=r.usage.total_tokens;await this.updateCostTracking(h);const p=r.choices[0].message.content;await this.sendToActiveTab({type:"ANALYSIS_STATUS",payload:{stage:"complete",productId:t.id,data:{response:p,timing:{apiCall:d}}}});try{const e=this.extractJsonFromResponse(p);return console.log("🔄 Extracted JSON:",{original:p,cleaned:e}),{...JSON.parse(e),timing:{total:d,apiCall:d}}}catch(e){throw await this.sendToActiveTab({type:"ANALYSIS_STATUS",payload:{stage:"error",productId:t.id,data:{error:"Failed to parse OpenAI response"}}}),new Error("Invalid analysis response format")}}catch(e){throw await this.sendToActiveTab({type:"ANALYSIS_STATUS",payload:{stage:"error",productId:t.id,data:{error:e instanceof Error?e.message:"Unknown error"}}}),e}}async showToast(e){await this.sendToActiveTab({type:"SHOW_TOAST",payload:e})}}})();
//# sourceMappingURL=background.js.map