(()=>{"use strict";new class{constructor(){this.state={isEnabled:!0,isScanning:!1,preferences:[],currentSearch:null,scanProgress:null},this.scanQueue=[],this.currentProduct=null,this.initialize()}async initialize(){console.log("🔍 Vinted Lens: Initializing content script");const e=await browser.storage.local.get(["preferences","currentSearch"]);this.state.preferences=e.preferences||[],this.state.currentSearch=e.currentSearch||null,console.log("📋 Loaded preferences:",this.state.preferences),console.log("🔎 Current search:",this.state.currentSearch),browser.runtime.onMessage.addListener(this.handleMessage.bind(this)),console.log("👂 Message listener set up")}handleMessage(e){switch(e.type){case"START_SCAN":this.handleStartScan(e.payload);break;case"STOP_SCAN":this.handleStopScan(e.payload);break;case"ANALYSIS_COMPLETE":this.handleAnalysisComplete(e.payload);break;case"ANALYSIS_STATUS":this.handleAnalysisStatus(e.payload);break;case"UPDATE_PREFERENCES":this.handlePreferencesUpdate(e.payload);break;case"UPDATE_SEARCH":this.handleSearchUpdate(e.payload);break;case"SHOW_TOAST":this.showToast(e.payload)}}handleAnalysisStatus(e){const{stage:t,productId:s,data:n}=e;switch(t){case"start":console.log(`🤖 Analyzing product ${s}:`,{prompt:n?.prompt});break;case"complete":console.log(`✅ Claude response for ${s}:`,{response:n?.response,timing:n?.timing});break;case"error":console.error(`❌ Analysis failed for ${s}:`,{error:n?.error})}}handleStartScan(e){this.state.isScanning?console.log("⏳ Scan already in progress"):(this.state.preferences=e.preferences,this.state.currentSearch=e.searchTerm,this.scanQueue=this.getUnanalyzedProducts(),0!==this.scanQueue.length?(this.state.isScanning=!0,this.state.scanProgress={total:this.scanQueue.length,current:0,currentItem:null,startTime:Date.now()},this.updateProgress(),this.processNextProduct()):this.showToast({message:"No items to analyze",type:"info"}))}handleStopScan(e){this.state.isScanning&&(console.log("🛑 Stopping scan:",e.reason),this.scanQueue=[],this.currentProduct=null,this.state.isScanning=!1,this.state.scanProgress=null,this.showToast({message:"complete"===e.reason?"Scan complete":"Scan stopped",type:"error"===e.reason?"error":"info"}),this.updateProgress())}getUnanalyzedProducts(){const e=[];return document.querySelectorAll(".feed-grid__item:not(.vinted-lens-analyzed)").forEach(((t,s)=>{const n=t.querySelector('img[data-testid="feed-item--image--img"]'),a=t.querySelector('[data-testid="feed-item--description-title"]'),r=t.querySelector('[data-testid="feed-item--overlay-link"]');n&&a&&r&&e.push({id:`item-${Date.now()}-${s}`,element:t,imageUrl:n.src,title:a.textContent||"",description:r.getAttribute("title")||""})})),e}async processNextProduct(){if(!this.state.isScanning)return;if(this.currentProduct)return void console.log("⏳ Waiting for current product to finish:",this.currentProduct.id);if(this.currentProduct=this.scanQueue.shift()||null,!this.currentProduct)return void this.handleStopScan({reason:"complete"});const e=this.currentProduct;console.log("🔄 Processing product:",e.id),this.state.scanProgress&&(this.state.scanProgress.current++,this.state.scanProgress.currentItem=e.title,this.updateProgress()),e.element.setAttribute("data-vinted-lens-id",e.id),e.element.classList.add("vinted-lens-analyzing");try{console.log("📤 Sending product for analysis:",{id:e.id,imageUrl:e.imageUrl,title:e.title,queueSize:this.scanQueue.length}),await browser.runtime.sendMessage({type:"ANALYZE_PRODUCT",payload:{product:{...e,element:void 0},preferences:this.state.preferences,searchTerm:this.state.currentSearch}})}catch(t){console.error("❌ Product analysis failed:",t),this.showToast({message:"Failed to analyze product",type:"error"}),e.element.classList.remove("vinted-lens-analyzing"),this.currentProduct=null,setTimeout((()=>this.processNextProduct()),1e3)}}handleAnalysisComplete(e){const{productId:t,analysis:s}=e;console.log("📥 Analysis complete:",{productId:t,matches:s.matches,confidence:s.confidence,timing:s.timing,queueSize:this.scanQueue.length});const n=document.querySelector(`.feed-grid__item[data-vinted-lens-id="${t}"]`);if(!n)return console.warn("⚠️ No element found for product:",t),this.currentProduct=null,void setTimeout((()=>this.processNextProduct()),1e3);n.classList.remove("vinted-lens-analyzing"),n.classList.add("vinted-lens-analyzed"),n.classList.add("vinted-lens-transition"),setTimeout((()=>{s.matches?(n.classList.add("vinted-lens-match"),s.confidence<.8&&n.classList.add("vinted-lens-low-confidence")):n.classList.add("vinted-lens-hidden"),this.currentProduct=null,setTimeout((()=>this.processNextProduct()),500)}),0)}updateProgress(){this.state.scanProgress&&browser.runtime.sendMessage({type:"SCAN_PROGRESS",payload:{progress:this.state.scanProgress}})}handlePreferencesUpdate(e){this.state.preferences=e.preferences,this.resetAnalysis()}handleSearchUpdate(e){this.state.currentSearch=e.search,this.resetAnalysis()}resetAnalysis(){this.state.isScanning&&this.handleStopScan({reason:"user"}),document.querySelectorAll(".vinted-lens-match, .vinted-lens-hidden, .vinted-lens-low-confidence, .vinted-lens-analyzed").forEach((e=>{e.classList.remove("vinted-lens-match","vinted-lens-hidden","vinted-lens-low-confidence","vinted-lens-analyzed"),e.removeAttribute("data-vinted-lens-id")}))}showToast(e){const t=document.createElement("div");t.className=`vinted-lens-toast ${e.type||""}`,t.textContent=e.message,document.body.appendChild(t),t.offsetHeight,t.classList.add("show"),setTimeout((()=>{t.classList.remove("show"),setTimeout((()=>t.remove()),300)}),e.duration||3e3)}}})();
//# sourceMappingURL=content.js.map